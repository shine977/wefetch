!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).wefetch=t()}(this,function(){"use strict";function e(){this.listeners={}}e.prototype.on=function(e,t){e in this.listeners||(this.listeners[e]=[]),this.listeners[e].push(t)},e.prototype.emit=function(e,t){var n=this.listeners[e];n&&n.forEach(function(e){e(t)})};var i=new e;function t(r){return function(n){(n=n||{}).config=n.config||{};for(var e=arguments.length,o=Array(1<e?e-1:0),t=1;t<e;t++)o[t-1]=arguments[t];return new Promise(function(e,t){n.config.eventType?i.emit(n.config.eventType,r.apply(void 0,[Object.assign({},n,{success:e,fail:t})].concat(o))):r.apply(void 0,[Object.assign({},n,{success:e,fail:t})].concat(o))})}}function n(){this.platform=null,this.api=null}n.prototype.getRequest=function(){return"undefined"!=typeof wx?(this.platform="wx",this.api=wx,t(wx.request)):"undefined"!=typeof my?(this.platform="my",this.api=my,my.request?t(my.request):t(my.httpRequest)):"undefined"!=typeof tt?(this.api=tt,this.platform="tt",t(tt.request)):"undefined"!=typeof swan?(this.api=swan,this.platform="swan",t(swan.request)):void 0},n.prototype.getUpload=function(){return t(this.api.uploadFile)},n.prototype.getDownload=function(){return t(this.api.downloadFile)};var o=new n,r={createRequest:o.getRequest(),header:{},config:{},method:"get",timeout:0};function u(o,r){return function(){for(var e=new Array(arguments.length),t=0,n=e.length;t<n;t++)e[t]=arguments[t];return o.apply(r,e)}}var f=Object.prototype.toString,s={type:function(){for(var e={},t=["String","Object","Number","Array","Undefined","Function","Null","Date"],n=0,o=t.length;n<o;n++)!function(t){e["is"+t]=function(e){return f.call(e)==="[object "+t+"]"}}(t[n]);return e}(),normalizeHeaderName:function(e){for(var t in e)/Content-Type/gi.test(t)&&(e["Content-Type"]=e[t],delete e[t])},forEach:function(e,t){if(e)if("object"!=typeof e&&(e=[e]),this.type.isArray(e))for(var n=0,o=e.length;n<o;n++)t.call(null,e[n],n,e);else for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.call(null,e[r],r,e)},merge:function(){var n={};function e(e,t){"object"==typeof n[t]&&"object"==typeof e?n[t]=s.merge(n[t],e):n[t]=e}for(var t=0,o=arguments.length;t<o;t++)this.forEach(arguments[t],e);return n},deepMerge:function(){var n={};function e(e,t){"object"==typeof n[t]&&"object"==typeof e?n[t]=s.deepMerge(n[t],e):n[t]="object"==typeof e?s.deepMerge({},e):e}for(var t=0,o=arguments.length;t<o;t++)this.forEach(arguments[t],e);return n},mergeConfig:function(t,n){var o={};return n=n||{},["url","method","data","config"].forEach(function(e){n[e]&&(o[e]=n[e])}),["header","headers"].forEach(function(e){s.type.isObject(n[e])?o[e]=s.deepMerge(t[e],n[e]):n[e]?o[e]=n[e]:s.type.isObject(t[e])?o[e]=s.deepMerge(t[e]):t[e]&&(o[e]=t[e])}),["baseUrl","timeout","eventType","createRequest"].forEach(function(e){void 0!==n[e]?o[e]=n[e]:void 0!==t[e]&&(o[e]=t[e])}),o},extends:function(n,e,o){return this.forEach(e,function(e,t){n[t]=o&&"function"==typeof e?u(e,o):e}),n}};function a(){this.handles=[]}function c(e){return s.normalizeHeaderName(e.header||e.headers),"download"===e.method&&(e.method="get",e.createRequest=o.getDownload()),"upload"===e.method&&(e.method="post",e.createRequest=o.getUpload()),(0,e.createRequest)(e).then(function(e){return e},function(e){return Promise.reject(e)})}function l(e){this.defaults=e,this.before=new a,this.after=new a}function p(e){var t=new l(e),n=u(l.prototype.request,t);return s.extends(n,l.prototype,t),s.extends(n,t),n}a.prototype.use=function(e,t){return this.handles.push({fulfilled:e,rejected:t}),this.handles.length-1},a.prototype.eject=function(e){this.handles[e]&&(this.handles[e]=null)},a.prototype.forEach=function(t){this.handles.forEach(function(e){e&&t(e)})},["options","get","head","post","put","delete","trace","connect"].forEach(function(n){l.prototype[n]=function(e,t){return this.request(s.merge(t||{},{url:e,method:n}))}}),l.prototype.download=function(e,t){return s.type.isObject(e)?this.request(s.merge(e,{method:"download"})):this.request(s.merge(t||{},{url:e,method:"download"}))},l.prototype.upload=function(e,t){return s.type.isObject(e)?this.request(e,{method:"upload"}):this.request(s.merge(t||{},{url:e,method:"upload"}))},l.prototype.on=function(e,t){i.on(e,t)},l.prototype.abort=function(e,t){this.on(e,function(e){e.abort(),t&&t()})},l.prototype.onProcess=function(e,t){this.on(e,function(e){e.onProgressUpdate(t)})},l.prototype.promisify=t,l.prototype.request=function(e){"string"==typeof e&&((e=arguments[1]||{}).url=arguments[0]),-1===(e=s.mergeConfig(this.defaults,e)).url.indexOf("http")&&(e.downloadUrl&&"download"===e.method?e.url=e.downloadUrl+e.url:e.uploadUrl&&"upload"===e.method?e.url=e.uploadUrl+e.url:e.url=e.baseUrl+e.url),"my"===o.platform&&"download"!==e.method&&"upload"!==e.method&&(e.headers=Object.assign({},e.header),delete e.header);var t=[c,void 0],n=Promise.resolve(e);for(this.before.forEach(function(e){t.unshift(e.fulfilled,e.rejected)}),this.after.forEach(function(e){t.push(e.fulfilled,e.rejected)});t.length;)n=n.then(t.shift(),t.shift());return n},Promise.prototype.finally=Promise.prototype.finally||function(t){var n=this.constructor;return this.then(function(e){n.resolve(t(e)).then(function(){return e})},function(e){n.resolve(t(e)).then(function(){return Promise.reject(e)})})};var h=p(r);return h.all=function(e){return Promise.all(e)},h.retry=function n(o,r,i){if(i=i||1e3,!o&&0!==o||!r)throw new Error("request and times params is required");if("function"!=typeof r)throw new Error("request must be a function, but got a\n"+typeof r);var u=r();return 1<o?(o--,new Promise(function(e,t){u.then(e).catch(function(){setTimeout(function(){e(n(o,r,i))},i)})})):u},h.create=function(e){return p(s.merge(r,e))},h});
